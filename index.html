<!DOCTYPE html>
<html>
<head>
    <title>Real-time Transcription and Translation</title>
    <style>
        body {
            font-family: sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100vh;
            margin: 0;
        }
        #controls {
            margin-bottom: 20px;
        }
        button {
            padding: 10px 20px;
            font-size: 16px;
            cursor: pointer;
        }
        .text-container {
            display: flex;
            justify-content: space-between;
            width: 90%;
            gap: 20px;
        }
        .text-container > div {
            flex: 1;
            display: flex;
            flex-direction: column;
        }
        .text-box {
            height: 300px;
            border: 1px solid #ccc;
            padding: 10px;
            overflow-y: scroll;
            flex-grow: 1;
        }
    </style>
</head>
<body>
    <h1>Transcription and Translation with Gemini 2.5 Flash</h1>
    <div id="controls">
        <button id="startBtn">Start Recording</button>
        <button id="stopBtn" disabled>Stop Recording</button>
        <label for="language">Translate to:</label>
        <select id="language" onchange="updateLanguage()">
            <option value="Arabic (Generic) (ar-XA)">Arabic (Generic)</option>
            <option value="Bengali (India) (bn-IN)">Bengali (India)</option>
            <option value="Danish (Denmark) (da-DK)">Danish (Denmark)</option>
            <option value="Dutch (Belgium) (nl-BE)">Dutch (Belgium)</option>
            <option value="Dutch (Netherlands) (nl-NL)">Dutch (Netherlands)</option>
            <option value="English (Australia) (en-AU)">English (Australia)</option>
            <option value="English (India) (en-IN)">English (India)</option>
            <option value="English (United Kingdom) (en-GB)">English (United Kingdom)</option>
            <option selected="selected" value="English (United States) (en-US)">English (United States)</option>
            <option value="Finnish (Finland) (fi-FI)">Finnish (Finland)</option>
            <option value="French (Canada) (fr-CA)">French (Canada)</option>
            <option value="French (France) (fr-FR)">French (France)</option>
            <option value="German (Germany) (de-DE)">German (Germany)</option>
            <option value="Gujarati (India) (gu-IN)">Gujarati (India)</option>
            <option value="Hindi (India) (hi-IN)">Hindi (India)</option>
            <option value="Indonesian (Indonesia) (id-ID)">Indonesian (Indonesia)</option>
            <option value="Italian (Italy) (it-IT)">Italian (Italy)</option>
            <option value="Japanese (Japan) (ja-JP)">Japanese (Japan)</option>
            <option value="Kannada (India) (kn-IN)">Kannada (India)</option>
            <option value="Korean (South Korea) (ko-KR)">Korean (South Korea)</option>
            <option value="Malayalam (India) (ml-IN)">Malayalam (India)</option>
            <option value="Mandarin Chinese (China) (cmn-CN)">Mandarin Chinese (China)</option>
            <option value="Marathi (India) (mr-IN)">Marathi (India)</option>
            <option value="Norwegian Bokmål (Norway) (nb-NO)">Norwegian Bokmål (Norway)</option>
            <option value="Polish (Poland) (pl-PL)">Polish (Poland)</option>
            <option value="Portuguese (Brazil) (pt-BR)">Portuguese (Brazil)</option>
            <option value="Russian (Russia) (ru-RU)">Russian (Russia)</option>
            <option value="Spanish (Spain) (es-ES)">Spanish (Spain)</option>
            <option value="Spanish (United States) (es-US)">Spanish (United States)</option>
            <option value="Swahili (Kenya) (sw-KE)">Swahili (Kenya)</option>
            <option value="Swedish (Sweden) (sv-SE)">Swedish (Sweden)</option>
            <option value="Tamil (India) (ta-IN)">Tamil (India)</option>
            <option value="Telugu (India) (te-IN)">Telugu (India)</option>
            <option value="Thai (Thailand) (th-TH)">Thai (Thailand)</option>
            <option value="Turkish (Turkey) (tr-TR)">Turkish (Turkey)</option>
            <option value="Ukrainian (Ukraine) (uk-UA)">Ukrainian (Ukraine)</option>
            <option value="Urdu (India) (ur-IN)">Urdu (India)</option>
            <option value="Vietnamese (Vietnam) (vi-VN)">Vietnamese (Vietnam)</option>
        </select>
    </div>
    
    <div class="text-container">
        <div>
            <h2>Transcription (Chinese (Simplified)):</h2>
            <div id="transcription" class="text-box"></div>
        </div>
        <div>
            <h2>Translation:</h2>
            <div id="translation" class="text-box"></div>
        </div>
    </div>

    <script>
        const startBtn = document.getElementById('startBtn');
        const stopBtn = document.getElementById('stopBtn');
        const transcriptionEl = document.getElementById('transcription');
        const translationEl = document.getElementById('translation');

        let socket;
        let mediaRecorder;
        let audioContext;
        let processor;
        let input;
        let globalStream;

        const connectWebSocket = () => {
            socket = new WebSocket('ws://localhost:8765');

            socket.onopen = () => {
                console.log('WebSocket connection established');
            };

            socket.onmessage = (event) => {
                if (event.data instanceof Blob) {
                    const audioUrl = URL.createObjectURL(event.data);
                    const audio = new Audio(audioUrl);
                    audio.play();
                } else {
                    const data = JSON.parse(event.data);
                    if (data.transcription) {
                        transcriptionEl.innerHTML += data.transcription + '<br>';
                        transcriptionEl.scrollTop = transcriptionEl.scrollHeight;
                    }
                    if (data.translation) {
                        translationEl.innerHTML += data.translation + '<br>';
                        translationEl.scrollTop = translationEl.scrollHeight;
                    }
                }
            };

            socket.onclose = () => {
                console.log('WebSocket connection closed');
            };

            socket.onerror = (error) => {
                console.error('WebSocket error:', error);
            };
        };
        
        const startRecording = async () => {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                globalStream = stream;
                audioContext = new (window.AudioContext || window.webkitAudioContext)({
                    sampleRate: 16000
                });
                input = audioContext.createMediaStreamSource(stream);
                processor = audioContext.createScriptProcessor(4096, 1, 1);

                processor.onaudioprocess = (e) => {
                    const inputData = e.inputBuffer.getChannelData(0);
                    const pcmData = new Int16Array(inputData.length);
                    for (let i = 0; i < inputData.length; i++) {
                        let s = Math.max(-1, Math.min(1, inputData[i]));
                        s = s < 0 ? s * 0x8000 : s * 0x7FFF;
                        pcmData[i] = s;
                    }
                    if (socket && socket.readyState === WebSocket.OPEN) {
                        socket.send(pcmData.buffer);
                    }
                };

                input.connect(processor);
                processor.connect(audioContext.destination);

                startBtn.disabled = true;
                stopBtn.disabled = false;
            } catch (err) {
                console.error('Error starting recording:', err);
            }
        };

        const stopRecording = () => {
            if (globalStream) {
                globalStream.getTracks().forEach(track => track.stop());
            }
            if (audioContext) {
                audioContext.close();
            }
            if (processor) {
                processor.disconnect();
            }
            if (input) {
                input.disconnect();
            }

            startBtn.disabled = false;
            stopBtn.disabled = true;
        };

        startBtn.addEventListener('click', startRecording);
        stopBtn.addEventListener('click', stopRecording);

        // Connect to WebSocket on page load
        connectWebSocket();

        const updateLanguage = () => {
            const language = document.getElementById('language').value;
            if (socket && socket.readyState === WebSocket.OPEN) {
                socket.send(JSON.stringify({ target_language: language }));
            }
        };
    </script>
</body>
</html>
